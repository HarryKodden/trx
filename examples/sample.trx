INCLUDE init.trx;
INCLUDE json_test.trx;

CONSTANT PI 3.14159;
CONSTANT APP_NAME "TRX Interpreter";

TYPE ADDRESS {
    STREET CHAR(64);
    ZIP INTEGER;
}

TYPE DEPARTMENT FROM TABLE department;

TYPE EMPLOYEE FROM TABLE employee;

TYPE PERSON FROM TABLE person;

// Initialize database with DEPARTMENT table
PROCEDURE init_department_table() {
    EXEC SQL CREATE TABLE IF NOT EXISTS department (
        id INTEGER PRIMARY KEY,
        name VARCHAR(64) NOT NULL,
        budget DECIMAL(12,2),
        location VARCHAR(128)
    )

    EXEC SQL INSERT INTO department (id, name, budget, location) VALUES (1, 'Engineering', 500000.00, 'Building A');
    EXEC SQL INSERT INTO department (id, name, budget, location) VALUES (2, 'Sales', 300000.00, 'Building B');
    EXEC SQL INSERT INTO department (id, name, budget, location) VALUES (3, 'Marketing', 200000.00, 'Building C');
}

// PERSON CRUD Operations

EXPORT FUNCTION get_all_persons() : INTEGER {
    RETURN 42;
}

EXPORT FUNCTION get_person_by_id(id: INTEGER) : INTEGER {
    RETURN id;
}

EXPORT METHOD POST FUNCTION create_person(person: PERSON) : PERSON {
    EXEC SQL INSERT INTO person (name, age, active, salary) VALUES (:person.name, :person.age, :person.active, :person.salary);

    IF SQLCODE = 0 {
        trace("Created person successfully");
        RETURN person;
    } ELSE {
        trace("Failed to create person");
        RETURN {};
    }
}

EXPORT METHOD PUT FUNCTION update_person(id: INTEGER, person: PERSON) : PERSON {
    EXEC SQL UPDATE person SET name = :person.name, age = :person.age, active = :person.active, salary = :person.salary
             WHERE id = :id;

    IF SQLCODE = 0 {
        person.id := id;
        trace("Updated person with ID: " + id);
        RETURN person;
    } ELSE {
        trace("Failed to update person with ID: " + id);
        RETURN {};
    }
}

EXPORT METHOD DELETE PROCEDURE delete_person(id: INTEGER) : BOOLEAN {
    EXEC SQL DELETE FROM person WHERE id = :id;

    IF SQLCODE = 0 {
        trace("Deleted person with ID: " + id);
        RETURN TRUE;
    } ELSE {
        trace("Failed to delete person with ID: " + id);
        RETURN FALSE;
    }
}

// DEPARTMENT CRUD Operations

EXPORT METHOD GET FUNCTION get_all_departments() : LIST(DEPARTMENT) {
    VAR departments LIST(DEPARTMENT);

    EXEC SQL DECLARE c2 CURSOR FOR SELECT id, name, budget, location FROM department ORDER BY id;
    EXEC SQL OPEN c2;

    VAR dept DEPARTMENT;
    WHILE TRUE {
        EXEC SQL FETCH c2 INTO :dept.id, :dept.name, :dept.budget, :dept.location;
        IF SQLCODE != 0 {
            BREAK;
        }
        APPEND(departments, dept);
    }

    EXEC SQL CLOSE c2;

    trace("Retrieved " + LEN(departments) + " departments");
    RETURN departments;
}

EXPORT METHOD GET FUNCTION get_department_by_id(id: INTEGER) : DEPARTMENT {
    VAR dept DEPARTMENT;

    EXEC SQL SELECT id, name, budget, location INTO :dept.id, :dept.name, :dept.budget, :dept.location
             FROM department WHERE id = :id;

    IF SQLCODE != 0 {
        trace("Department with ID " + id + " not found");
        RETURN {};
    }

    trace("Retrieved department: " + dept.name);
    RETURN dept;
}

EXPORT METHOD POST FUNCTION create_department(dept: DEPARTMENT) : DEPARTMENT {
    EXEC SQL INSERT INTO department (name, budget, location) VALUES (:dept.name, :dept.budget, :dept.location);

    IF SQLCODE = 0 {
        trace("Created department successfully");
        RETURN dept;
    } ELSE {
        trace("Failed to create department");
        RETURN {};
    }
}

EXPORT METHOD PUT FUNCTION update_department(id: INTEGER, dept: DEPARTMENT) : DEPARTMENT {
    EXEC SQL UPDATE department SET name = :dept.name, budget = :dept.budget, location = :dept.location
             WHERE id = :id;

    IF SQLCODE = 0 {
        dept.id := id;
        trace("Updated department with ID: " + id);
        RETURN dept;
    } ELSE {
        trace("Failed to update department with ID: " + id);
        RETURN {};
    }
}

EXPORT METHOD DELETE PROCEDURE delete_department(id: INTEGER) : BOOLEAN {
    EXEC SQL DELETE FROM department WHERE id = :id;

    IF SQLCODE = 0 {
        trace("Deleted department with ID: " + id);
        RETURN TRUE;
    } ELSE {
        trace("Failed to delete department with ID: " + id);
        RETURN FALSE;
    }
}

// EMPLOYEE CRUD Operations

EXPORT METHOD GET FUNCTION get_all_employees() : LIST(EMPLOYEE) {
    VAR employees LIST(EMPLOYEE);

    EXEC SQL DECLARE c3 CURSOR FOR
        SELECT e.person_id, e.department, p.name, p.age, p.active, p.salary
        FROM employee e
        JOIN person p ON e.person_id = p.id
        ORDER BY e.person_id;

    EXEC SQL OPEN c3;

    VAR emp EMPLOYEE;
    VAR person PERSON;
    WHILE TRUE {
        EXEC SQL FETCH c3 INTO :emp.person_id, :emp.department, :person.name, :person.age, :person.active, :person.salary;
        IF SQLCODE != 0 {
            BREAK;
        }
        APPEND(employees, emp);
    }

    EXEC SQL CLOSE c3;

    trace("Retrieved " + LEN(employees) + " employees");
    RETURN employees;
}

EXPORT METHOD GET FUNCTION get_employee_by_id(person_id: INTEGER) : EMPLOYEE {
    VAR emp EMPLOYEE;

    EXEC SQL SELECT person_id, department INTO :emp.person_id, :emp.department
             FROM employee WHERE person_id = :person_id;

    IF SQLCODE != 0 {
        trace("Employee with person ID " + person_id + " not found");
        RETURN {};
    }

    trace("Retrieved employee for person ID: " + person_id);
    RETURN emp;
}

EXPORT METHOD POST FUNCTION create_employee(emp: EMPLOYEE) : EMPLOYEE {
    EXEC SQL INSERT INTO employee (person_id, department) VALUES (:emp.person_id, :emp.department);

    IF SQLCODE = 0 {
        trace("Created employee for person ID: " + emp.person_id);
        RETURN emp;
    } ELSE {
        trace("Failed to create employee for person ID: " + emp.person_id);
        RETURN {};
    }
}

EXPORT METHOD PUT FUNCTION update_employee(person_id: INTEGER, emp: EMPLOYEE) : EMPLOYEE {
    EXEC SQL UPDATE employee SET department = :emp.department WHERE person_id = :person_id;

    IF SQLCODE = 0 {
        emp.person_id := person_id;
        trace("Updated employee for person ID: " + person_id);
        RETURN emp;
    } ELSE {
        trace("Failed to update employee for person ID: " + person_id);
        RETURN {};
    }
}

EXPORT METHOD DELETE PROCEDURE delete_employee(person_id: INTEGER) : BOOLEAN {
    EXEC SQL DELETE FROM employee WHERE person_id = :person_id;

    IF SQLCODE = 0 {
        trace("Deleted employee for person ID: " + person_id);
        RETURN TRUE;
    } ELSE {
        trace("Failed to delete employee for person ID: " + person_id);
        RETURN FALSE;
    }
}

// Initialize the database
PROCEDURE main() {
    init_department_table();
    trace("Database initialized with CRUD sample data");
}
